import { Component, EventEmitter, Input, OnChanges, Output } from '@angular/core';
import { DataZoomComponentOption, ECharts, EChartsOption } from 'echarts';

@Component({
  selector: 'tfm-chart',
  templateUrl: './tfm-chart.component.html',
  styleUrls: ['./tfm-chart.component.sass']
})
export class TfmChartComponent implements OnChanges {
  @Input() options: EChartsOption;

  @Output() onLegendSelectionChanges = new EventEmitter();

  chartOpts: EChartsOption;
  chart: ECharts;

  ngOnChanges(): void {
    if (this.options != null) {
      const hasVerticalZoom =
        this.options.dataZoom != null &&
        (this.options.dataZoom as DataZoomComponentOption[]).some(
          (d: DataZoomComponentOption) => d.yAxisIndex != null
        );
      const hasHorizontalZoom =
        this.options.dataZoom != null &&
        (this.options.dataZoom as DataZoomComponentOption[]).some(
          (d: DataZoomComponentOption) => d.yAxisIndex == null
        );

      this.chartOpts = {
        ...this.options,
        title: {},
        textStyle: this.getTextStyle(),
        legend: {
          ...this.options.legend,
          textStyle: this.getTextStyle(),
          align: 'auto',
          bottom: 0,
          padding: 0
        },
        grid: {
          width: hasVerticalZoom ? '88%' : '100%',
          left: 20,
          right: 30,
          top: 30,
          bottom: hasHorizontalZoom ? 60 : 40,
          containLabel: true
        }
      };
    }
  }

  onChartInit(e: ECharts) {
    this.chart = e;
    this.chart.on('legendselectchanged', (event: any) => {
      this.onLegendSelectionChanges.emit(event.selected);
    });
  }

  private getTextStyle() {
    return {
      fontFamily: 'Ysabeau',
      color: '#6e6e6e'
    };
  }
}
