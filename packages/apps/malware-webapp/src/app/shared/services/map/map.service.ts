import { Injectable } from '@angular/core';
import * as L from 'leaflet';

@Injectable()
export class MapService {
  private readonly maps: Record<string, L.Map> = {};
  private readonly baseMap = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
  private readonly defaultOpts: L.MapOptions = {
    attributionControl: false,
    center: [0, 0],
    zoom: 2
  };

  createNewMapInstance(id: string, options?: L.MapOptions): L.Map {
    const map = L.map(id, { ...this.defaultOpts, ...options });

    this.addCartoLayerToMap(map);
    this.addResizeObserverToMap(id, map);
    this.maps[id] = map;

    return map;
  }

  private addCartoLayerToMap(map: L.Map): void {
    const cartoLayer = L.tileLayer(
      'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
      {
        maxZoom: 20
      }
    );

    cartoLayer.addTo(map);
  }

  private addResizeObserverToMap(id: string, map: L.Map): void {
    const mapDiv = document.getElementById(id);
    const resizeObserver = new ResizeObserver(() => map.invalidateSize());

    resizeObserver.observe(mapDiv);
  }
}
