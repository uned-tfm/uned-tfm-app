import { Component, OnInit } from '@angular/core';
import { EChartsOption } from 'echarts';
import { sortBy } from 'lodash';
import { findMalwareTypeByMalwareType } from '../../../../../../dependencies/use-cases/malware-types';
import { CountByMalwareType } from '@core/malware/malware-types/domain/models/malware-type';

@Component({
  selector: 'tfm-malware-type-by-malware',
  templateUrl: './malware-type-by-malware.component.html',
  styleUrls: ['./malware-type-by-malware.component.sass']
})
export class MalwareTypeByMalwareComponent implements OnInit {
  chartOpts: EChartsOption;

  async ngOnInit(): Promise<void> {
    await this.initMalwareTypeMalwareChart();
  }

  private async initMalwareTypeMalwareChart(): Promise<void> {
    const malwareData = await findMalwareTypeByMalwareType();
    const data = this.filterAndFormatData(malwareData);

    this.chartOpts = {
      tooltip: {
        trigger: 'axis',
        axisPointer: {
          type: 'shadow'
        }
      },
      legend: {},
      grid: {},
      xAxis: {
        type: 'category',
        data: data.map((d) => d.malwareType),
        axisLabel: {
          rotate: 330
        }
      },
      yAxis: {
        type: 'value'
      },
      series: [
        {
          type: 'bar',
          name: 'NÃºmero de ficheros maliciosos',
          data: data.map((d) => d.result)
        }
      ],
      dataZoom: [
        {
          show: true,
          start: 95,
          end: 100,
          height: 20,
          bottom: '30px'
        },
        {
          show: true,
          yAxisIndex: 0,
          filterMode: 'empty',
          showDataShadow: false,
          right: '40px'
        }
      ],
      color: ['rgb(217,95,14)', '#4575b4']
    };
  }

  private filterAndFormatData(data: CountByMalwareType[]) {
    data = data.filter((d) => d.malwareType != null);
    return sortBy(data, 'result');
  }
}
