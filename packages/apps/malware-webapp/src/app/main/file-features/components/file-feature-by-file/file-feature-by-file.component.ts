import { Component, OnInit } from '@angular/core';
import { EChartsOption } from 'echarts';
import { findFileFeatureByFileType } from '../../../../../../dependencies/use-cases/file-features';
import { sortBy, sumBy } from 'lodash';
import { FileFeatureByFileType } from '@core/malware/file-features/domain/models/file-feature';

@Component({
  selector: 'tfm-file-feature-by-file',
  templateUrl: './file-feature-by-file.component.html',
  styleUrls: ['./file-feature-by-file.component.sass']
})
export class FileFeatureByFileComponent implements OnInit {
  chartOpts: EChartsOption;

  async ngOnInit(): Promise<void> {
    await this.initFileFeatureByFileChart();
  }

  formatNumber(num: number): string {
    return new Intl.NumberFormat('ES-es').format(num);
  }

  private async initFileFeatureByFileChart(): Promise<void> {
    const data = await findFileFeatureByFileType();

    this.chartOpts = {
      tooltip: { trigger: 'item' },
      legend: {},
      series: [
        {
          type: 'pie',
          radius: ['30%', '90%'],
          avoidLabelOverlap: false,
          itemStyle: { borderRadius: 10, borderColor: '#f9f9f7', borderWidth: 2 },
          label: { show: false, position: 'center' },
          emphasis: { label: { show: true, fontSize: 40, fontWeight: 'bold' } },
          labelLine: { show: false },
          data: this.filterAndFormatData(data)
        }
      ],
      color: [
        '#a6cee3',
        '#1f78b4',
        '#b2df8a',
        '#33a02c',
        '#fb9a99',
        '#e31a1c',
        '#fdbf6f',
        '#ff7f00',
        '#cab2d6',
        '#6a3d9a'
      ]
    };
  }

  private filterAndFormatData(data: FileFeatureByFileType[]) {
    data = data.filter((d) => d.fileType != null);
    const otherFilter = data.slice(9);
    data = data.slice(0, 9);
    data.push({ fileType: 'other', result: sumBy(otherFilter, 'result') });

    data = sortBy(data, 'result').reverse();

    return data.map((d) => ({ name: d.fileType, value: d.result }));
  }
}
