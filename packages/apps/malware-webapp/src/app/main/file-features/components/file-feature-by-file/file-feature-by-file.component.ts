import { Component, OnInit } from '@angular/core';
import { EChartsOption } from 'echarts';
import { findFileFeatureByFileType } from '../../../../../../dependencies/use-cases/file-features';
import { sumBy } from 'lodash';
import { FileFeatureByFileType } from '@core/malware/file-features/domain/models/file-feature';

@Component({
  selector: 'tfm-file-feature-by-file',
  templateUrl: './file-feature-by-file.component.html',
  styleUrls: ['./file-feature-by-file.component.sass']
})
export class FileFeatureByFileComponent implements OnInit {
  chartOpts: EChartsOption;

  async ngOnInit(): Promise<void> {
    await this.initDeliveryMethodByFileChart();
  }

  formatNumber(num: number): string {
    return new Intl.NumberFormat('ES-es').format(num);
  }

  private async initDeliveryMethodByFileChart(): Promise<void> {
    const data = await findFileFeatureByFileType();

    this.chartOpts = {
      tooltip: { trigger: 'item' },
      legend: {},
      series: [
        {
          type: 'pie',
          radius: ['30%', '90%'],
          avoidLabelOverlap: false,
          itemStyle: { borderRadius: 10, borderColor: '#f9f9f7', borderWidth: 2 },
          label: { show: false, position: 'center' },
          emphasis: { label: { show: true, fontSize: 40, fontWeight: 'bold' } },
          labelLine: { show: false },
          data: this.filterAndFormatData(data)
        }
      ],
      color: ['#d73027', '#f46d43', '#fdae61', '#fee090', '#74add1', '#4575b4']
    };
  }

  private filterAndFormatData(data: FileFeatureByFileType[]) {
    data = data.filter((d) => d.fileType != null);
    const otherFilter = data.filter((d) => d.result < 9000);
    data = data.filter((d) => d.result >= 9000);
    data.push({ fileType: 'other', result: sumBy(otherFilter, 'result') });

    return data.map((d) => ({ name: d.fileType, value: d.result }));
  }
}
