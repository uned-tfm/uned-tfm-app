import { Component, OnInit } from '@angular/core';
import { EChartsOption } from 'echarts';
import { findDeliveryMethodByMalwareType } from '../../../../../../dependencies/use-cases/delivery-methods';
import { DeliveryMethodByMalwareType } from '@core/malware/delivery-methods/domain/models/delivery-method';
import { groupBy, sortBy, sumBy } from 'lodash';

@Component({
  selector: 'tfm-delivery-method-by-malware',
  templateUrl: './delivery-method-by-malware.component.html',
  styleUrls: ['./delivery-method-by-malware.component.sass']
})
export class DeliveryMethodByMalwareComponent implements OnInit {
  chartOpts: EChartsOption;

  async ngOnInit(): Promise<void> {
    await this.initDeliveryMethodByMalwareChart();
  }

  formatNumber(num: number): string {
    return new Intl.NumberFormat('ES-es').format(num);
  }

  private async initDeliveryMethodByMalwareChart(): Promise<void> {
    let data = await findDeliveryMethodByMalwareType();
    data = data.filter((d) => d.deliveryMethod != null && d.malwareType != null);

    const series = this.filterData(data);
    const dimensions = ['malware', ...sortBy(Object.keys(groupBy(data, 'deliveryMethod')))];

    this.chartOpts = {
      dataset: {
        dimensions,
        source: Object.keys(series).map((key) => {
          const serie = series[key];
          const result: Record<string, unknown> = { malware: key };

          for (const { deliveryMethod, count } of serie) {
            result[deliveryMethod] = count;
          }

          return result;
        })
      },
      tooltip: {
        trigger: 'axis',
        axisPointer: {
          type: 'shadow'
        }
      },
      legend: {},
      grid: {},
      xAxis: {
        type: 'category',
        data: Object.keys(series),
        axisLabel: {
          rotate: 330
        },
        name: 'Familia de malware',
        nameLocation: 'middle',
        nameTextStyle: {
          padding: 40,
          fontWeight: 'bold'
        }
      },
      yAxis: {
        type: 'value',
        nameLocation: 'middle',
        name: 'Num. de detecciones',
        nameTextStyle: {
          padding: 40,
          fontWeight: 'bold'
        }
      },
      series: [
        {
          type: 'bar'
        },
        {
          type: 'bar'
        },
        {
          type: 'bar'
        },
        {
          type: 'bar'
        },
        {
          type: 'bar'
        },
        {
          type: 'bar'
        }
      ],
      dataZoom: [
        {
          show: true,
          yAxisIndex: 0,
          filterMode: 'empty',
          showDataShadow: false,
          right: '40px'
        }
      ],
      color: ['#d73027', '#f46d43', '#fdae61', '#fee090', '#74add1', '#4575b4', '#244167']
    };
  }

  private filterData(data: DeliveryMethodByMalwareType[]) {
    const malwareTypes = groupBy(data, 'malwareType');

    for (const key of Object.keys(malwareTypes)) {
      malwareTypes[key] = sortBy(malwareTypes[key], ['count']).reverse();

      if (malwareTypes[key].length < 6 || sumBy(malwareTypes[key], 'count') < 500) {
        delete malwareTypes[key];
      }
    }

    return malwareTypes;
  }
}
